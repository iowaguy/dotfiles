#!/usr/bin/env nix-shell
#! nix-shell -i bash -p dmidecode python3

set -eu -o pipefail
shopt -s failglob

HOME_MANAGER_VERSION=21.05
DOTFILES_BASE=workspace/dotfiles
NIX_CONFIG_BASE_DIR=${HOME}/${DOTFILES_BASE}
GIT_HOME="https://github.com/iowaguy/dotfiles"

PYTHON=$(which python3)
GIT=$(which git)

declare -A machines
machines['MacBookPro11,5']=boston.nix
machines['20A8S1BJ00']=kansas.nix
machines['Precision Tower 3620']=isec-desktop.nix

system_config() {
  POSSIBLE_MNT=$1

  # Nix configuration
  sudo cp ${NIX_CONFIG_BASE_DIR}/system/configuration.nix ${POSSIBLE_MNT}/etc/nixos/
  sudo cp -r ${NIX_CONFIG_BASE_DIR}/system/machine/ ${POSSIBLE_MNT}/etc/nixos/
  sudo cp -r ${NIX_CONFIG_BASE_DIR}/system/wm/ ${POSSIBLE_MNT}/etc/nixos/
  sudo cp -r ${NIX_CONFIG_BASE_DIR}/nix/ ${POSSIBLE_MNT}/etc/nixos/

  machine_id=$(head -c4 /dev/urandom | od -A none -t x4)
  model="$(sudo dmidecode -s system-product-name)"

  if [ ! -f ${POSSIBLE_MNT}/etc/nixos/machine/current.nix ]; then
    echo "Linking current machine's configuration (${model})"
    sudo ln -s "${POSSIBLE_MNT}/etc/nixos/machine/${machines[${model}]}" ${POSSIBLE_MNT}/etc/nixos/machine/current.nix
  fi
  sudo sed -i "s/REPLACE_ME/${machine_id}/g" ${POSSIBLE_MNT}/etc/nixos/machine/current.nix
}

system_fresh_install() {
  if [ ! "$USER" = "root" ]; then
    echo "Must be run as root!"
    exit 1
  fi

  fresh_install
  system_config "/mnt"
  nixos-install -v --show-trace --root /mnt
  zfs snapshot -r rpool/nixos@install
}

system_install() {
  system_config ""
  sudo nixos-rebuild switch --upgrade
}

system_refresh() {
  system_config
  sudo nixos-rebuild switch
}

hm_install() {
  # Home manager
  mkdir -p $HOME/.config/nixpkgs/
  cp -r home/* $HOME/.config/nixpkgs/
  nix-channel --add https://github.com/nix-community/home-manager/archive/release-${HOME_MANAGER_VERSION}.tar.gz home-manager
  nix-channel --update
  export NIX_PATH=$HOME/.nix-defexpr/channels${NIX_PATH:+:}$NIX_PATH
  nix-shell '<home-manager>' -A install

  hm_refresh
}

hm_refresh() {
  if [ ! -f $HOME/.config/nixpkgs/home.nix ]; then
    echo "Linking home.nix..."
    ln -s $HOME/workspace/dotfiles/home/home.nix $HOME/.config/nixpkgs/home.nix
  fi
  home-manager switch
}

install() {
  system_install
  hm_install

  # Set screenlock wallpaper
  betterlockscreen -u home/resources/background_image
  exit $?
}

refresh() {
  system_refresh
  if [ $? == 0 ]; then
    hm_refresh
  fi
  exit $?
}

update() {
  pushd ${NIX_CONFIG_BASE_DIR}
  $PYTHON ${NIX_CONFIG_BASE_DIR}/nix/update.py
  popd
  if [ $? == 0 ]; then
    refresh
  fi
  exit $?
}

usage() {
  echo "Usage: $0 [install|refresh|update]" 1>&2
  exit 1
}

fresh_install() {
  set -x
  set -e

  ls /dev/disk/by-id/ata-*
  read -p "What disk to partition (e.g. /dev/disk/by-id/ata-VENDOR-ID-OF-THE-DRIVE)? " DISK
  # read -p "What disk to format (e.g. /dev/sda, /dev/nvme0n1)? " DISK
  ls $DISK* # this is just to check that it exists

  INST_ID=nixos

  INST_PRIMARY_DISK=$(echo $DISK | cut -f1 -d\ )

  INST_PARTSIZE_ESP=2 # in GB

  # wipe solid-state drives with the generic tool blkdiscard, to clean previous partition tables and improve performance
  blkdiscard -f $DISK &
  wait

  # remove all partitions on disk
  sgdisk --zap-all $DISK

  # boot partition
  sgdisk -n1:1M:+${INST_PARTSIZE_ESP}G -t1:EF00 $INST_PRIMARY_DISK

  # root partition
  sgdisk -n2:0:0 -t2:BF01 $INST_PRIMARY_DISK

  mkfs.vfat ${INST_PRIMARY_DISK}-part1

  # Create root pool. Must happen before boot pool
  zpool create \
    -o autotrim=on \
    -O acltype=posix \
    -O mountpoint=none \
    rpool \
    $DISK-part2

  # create encrypted root container
  zfs create \
  -o mountpoint=legacy \
  -o encryption=aes-256-gcm \
  -o keylocation=prompt \
  -o keyformat=passphrase \
  rpool/$INST_ID

  # Create other system datasets
  zfs create -p -o mountpoint=legacy rpool/$INST_ID/root
  zfs create -p -o mountpoint=legacy rpool/$INST_ID/root/nixos
  zfs create -p -o mountpoint=legacy rpool/$INST_ID/home

  # mount things
  mount -t zfs rpool/$INST_ID/root/nixos /mnt
  mkdir /mnt/{boot,home}
  mount -t zfs rpool/$INST_ID/home /mnt/home
  mount ${DISK}-part1 /mnt/boot

  nixos-generate-config --root /mnt

  mkdir -p /root/workspace
  $GIT clone $GIT_HOME /root/$DOTFILES_BASE
}

while :; do
  PARAM=`echo $1 | awk -F= '{print $1}'`
  VALUE=`echo $1 | awk -F= '{print $2}'`
  case "$PARAM" in
    install)
      install
      ;;
    refresh)
      refresh
      ;;
    update)
      update
      ;;
    fresh)
      system_fresh_install
      ;;
    *)
      echo "ERROR: unknown parameter \"$PARAM\""
      usage
      ;;
  esac
  shift
done
